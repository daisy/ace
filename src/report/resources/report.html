<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap4.min.js"></script>

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap4.min.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.css"/>

  <script type="text/javascript" src="js/ace-report-viewer.js"></script>
  <script type="text/javascript" src="js/aceReportData.js"></script>
  <script type="text/javascript">

  var aceReportViewer = null;

  function updateTableContents(data) {
    $('#report-table').dataTable().fnDestroy();
    var tablebody = $("#report-table > tbody");
    tablebody.empty();


    data.forEach(function(violation) {

      var tr = $("<tr></tr>");

      var tdImpact = $("<td>" + violation["impact"] + "</td>");

      var tdFile = $("<td>" + violation["file"] + "<br/><br/><em>\"" + aceReportViewer.getTitleForFile(violation["file"]) + "\"</em></td>");

      var tdTarget = $("<td><code>"
        + violation["pointer"]["css"]
        + "<br/><br/>"
        + violation["pointer"]["cfi"]
        + "</code></td>");

      var tdRule = $("<td>" + violation["rule"] + "</td>");

      var desc = violation["desc"];
      desc = desc.replace("Fix all of the following:", "");
      desc = desc.replace("Fix any of the following:", "");

      var descArr = desc.split("\n");
      var tdDesc = $("<td></td>");
      var ul = $("<ul></ul>");
      tdDesc.append(ul);
      descArr.forEach(function(item) {
        if (item != "") {
          var elm = $("<li></li>");
          elm.text(item);
          ul.append(elm);
        }
      });

      var tdLink = $("<td><a href='"
        + violation["kburl"]
        + "' target='_blank'>More info</a></td>");

      var tdEngine = $("<td>" + violation["engine"] + "</td>");

      tr.append(tdImpact);
      tr.append(tdFile);
      tr.append(tdTarget);
      tr.append(tdRule);
      tr.append(tdDesc);
      tr.append(tdLink);
      tr.append(tdEngine);
      tablebody.append(tr);

    });

    $('#report-table').DataTable();
  }

  function filterSelected() {
    var filters = [];
    $("select").each(function(idx, elm) {
      $(elm).children("option").each(function (idx, optElm) {
        if (optElm.selected) {
          filters[elm.name] = optElm.value;
        }
      });
    });

    var filteredData = aceReportViewer.filterViolations(filters);
    updateTableContents(filteredData);
  }

  function applyMetadata(metadata) {

    $("#pub-title").text(metadata["pubTitle"]);
    $("#pub-identifier").text(metadata["pubIdentifier"]);
    $("#software-name").text(metadata["softwareName"]);
    $("#software-version").text(metadata["softwareVersion"]);
    $("#report-date").text(metadata["reportDate"]);

  }

  function populateFilters(filters) {
    $("#filters").empty();

    filters.forEach(function(filter) {
      $("#filters").append("<span class='filter-label'>" + filter.name + "</span>");
      var filterSelect = $("<select name='" + filter.name + "'></select>");
      $("#filters").append(filterSelect);
      filter.values.forEach(function(value) {
        if (value === "all") {
          // preselect 'all'
          filterSelect.append("<option value='all' selected>All</option>");
        }
        else {
          filterSelect.append("<option value='" + value + "'>" + value + "</option>");
        }
      });
    });
    $('select').change(filterSelected);
  }

  function populateOutlines(outlines) {
    var section = $('#outlines');
    section.append('<h3>EPUB Table of Contents</h3>');
    section.append(outlines.toc);
    section.append('<h3>Headings outline</h3>');
    section.append(outlines.headings);
    section.append('<h3>HTML outline</h3>');
    section.append(outlines.html);
  }

  function populateImagesTable(images) {
    $('#image-table').dataTable().fnDestroy();
    var tablebody = $("#image-table > tbody");
    tablebody.empty();
    images.forEach(function(image) {
      var tr = $("<tr></tr>");

      var tdImage = $('<td class="image">'
        + '<a href="data/' + image['path'] + '">'
        + '<img src="data/' + image['path'] + '" '
        +  'alt="' + image['alt'] + '"/>'
        + '</a></td>');
      tr.append(tdImage);


      var tdAlt = (image.alt === undefined) ?
      $('<td class="missing">N/A</td>')
       : $('<td>' + image.alt + '</td>');
      tr.append(tdAlt);

      var tdDescribedby = (image.describedby === undefined) ?
      $('<td class="missing">N/A</td>')
       : $('<td>' + image.describedby + '</td>');
      tr.append(tdDescribedby);

      var tdFigcaption = (image.figcaption === undefined) ?
      $('<td class="missing">N/A</td>')
       : $('<td>' + image.figcaption + '</td>');
      tr.append(tdFigcaption);

      var tdLocation = $('<td class="location">'
        + image['location']
        + '</td>');
      tr.append(tdLocation);


      tablebody.append(tr);

    });

    $('#report-table').DataTable();

  }

  function populateExtendedMetadata(metadata) {
    var dl = $('#pub-metadata');
    for(key in metadata) {
      dl.append('<dt>' + key + '</dt>');
      dl.append('<dd>' + metadata[key] + '</dd>');
    }
  }

  $(document).ready(function() {
    aceReportViewer = new AceReport(aceReportData);

    applyMetadata(aceReportViewer.getMetadata());

    // populate extended metadata
    populateExtendedMetadata(aceReportData["earl:testSubject"].metadata);

    // populate filters
    populateFilters(aceReportViewer.getFilters());

    // populate table
    updateTableContents(aceReportViewer.getAllViolations());

    // populate outlines
    populateOutlines(aceReportData.outlines);

    // populate the images table
    populateImagesTable(aceReportData.data.images);

  });



  </script>
  <style>
  #filters span, #filters select {
    padding-left: 10px;
    padding-right: 10px;
  }

  .filter-label {
    text-transform: capitalize;
  }

  .toc-h1:before,.toc-h2:before,.toc-h3:before,.toc-h4:before,.toc-h5:before,.toc-h6:before,.toc-missing{
    display:inline-block;
    height:1.5em;
    padding:0 .4em;
    background-color:#449d44;
    border-radius:4px;
    color:#fff;
    font-size:.8em;
    font-family:monospace;
    margin:0 .5em 0 0
  }

  .toc-h1:before{content:'h1'}
  .toc-h2:before{content:'h2'}
  .toc-h3:before{content:'h3'}
  .toc-h4:before{content:'h4'}
  .toc-h5:before{content:'h5'}
  .toc-h6:before{content:'h6'}
  .toc-missing{font-family:inherit;background-color:#c9302c}
  td.image{
    text-align:center;
    padding:.2em;
  }
  td.image img {
    max-width: 100%;
  }
td.missing{
    text-align:center;
    color:#888;
    font-style:italic
}
td.alt {border:1px solid #ddd}
td.alt.missing{background-color:#f2dede}
td.alt,td.image.presentation+td.alt.missing{background-color:#dff0d8}
td.location{font-size:.8em;font-family:monospace;overflow-wrap:break-word}
td code {
  line-height: 1.5;
}

  table th {
    width: auto !important;
  }
  </style>



  <title>EPUB Accessibility Report by DAISY Ace</title>
</head>
<body>

  <div id="report-metadata" class="jumbotron">
    <h1>EPUB Accessiblity Report</h1>
    <dl>
      <dt>Publication Title</dt>
      <dd id="pub-title"></dd>
      <dt>Publication Identifier</dt>
      <dd id="pub-identifier"></dd>
      <dt>Report generated by</dt>
      <dd><span id="software-name"></span> (<span id="software-version"></span>)</dd>
      <dt>Report created on</dt>
      <dd id="report-date"></dd>
    </dl>
    <details>
      <summary>Metadata details</summary>
      <dl id="pub-metadata"></dl>
    </details>
  </div>

  <div class="container-fluid">
    <h2>Violations</h2>

    <div id="filters" class="py-3">
    </div>

    <table id="report-table" class="table table-striped table-bordered">
      <thead class="thead-inverse">
        <tr>
          <th>Impact</th>
          <th>File</th>
          <th>Target</th>
          <th>Rule</th>
          <th>Description</th>
          <th>KB Link</th>
          <th>Engine</th>
        </tr>
      </thead>
      <tbody>
      </tbody>

    </table>
  </div>

  <div id="outlines" class="container-fluid">
    <h2>Outlines</h2>
  </div>

  <div id="images" class="container-fluid">
    <h2>Images</h2>
    <table  id="image-table" class="table table-striped table-bordered">
      <caption>Images in the EPUB, with their description</caption>
      <thead class="thead-inverse">
         <tr>
            <th>Image</th>
            <th><code>alt</code> attribute
            </th>
            <th><code>aria-describedby</code> content
            </th>
            <th>Associated <code>figcaption</code></th>
            <th>Location</th>
         </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>


</body>

</html>
