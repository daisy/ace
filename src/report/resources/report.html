<html>
<head>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap4.min.js"></script>

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap4.min.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.css"/>

  <script type="text/javascript" src="js/ace-report-viewer.js"></script>
  <script type="text/javascript" src="js/aceReportData.js"></script>
  <script type="text/javascript">

  var aceReportViewer = null;

  function updateTableContents(data) {
    $('#report-table').dataTable().fnDestroy();
    var tablebody = $("#report-table > tbody");
    tablebody.empty();


    data.forEach(function(violation) {

      var tr = $("<tr></tr>");

      var tdImpact = $("<td>" + violation["impact"] + "</td>");

      var tdFile = $("<td>" + violation["file"] + "<br/><br/><em>\"" + aceReportViewer.getTitleForFile(violation["file"]) + "\"</em></td>");

      var tdTarget = $("<td><code>"
        + violation["pointer"]["css"]
        + "<br/><br/>"
        + violation["pointer"]["cfi"]
        + "</code></td>");

      var tdRule = $("<td>" + violation["rule"] + "</td>");

      var desc = violation["desc"];
      desc = desc.replace("Fix all of the following:", "");
      desc = desc.replace("Fix any of the following:", "");

      var descArr = desc.split("\n");
      var tdDesc = $("<td></td>");
      var ul = $("<ul></ul>");
      tdDesc.append(ul);
      descArr.forEach(function(item) {
        if (item != "") {
          var elm = $("<li></li>");
          elm.text(item);
          ul.append(elm);
        }
      });

      var tdLink = $("<td><a href='"
        + violation["kburl"]
        + "' target='_blank'>More info</a></td>");

      var tdEngine = $("<td>" + violation["engine"] + "</td>");

      tr.append(tdImpact);
      tr.append(tdFile);
      tr.append(tdTarget);
      tr.append(tdRule);
      tr.append(tdDesc);
      tr.append(tdLink);
      tr.append(tdEngine);
      tablebody.append(tr);

    });

    $('#report-table').DataTable();
  }

  function filterSelected() {
    var filters = [];
    $("select").each(function(idx, elm) {
      $(elm).children("option").each(function (idx, optElm) {
        if (optElm.selected) {
          filters[elm.name] = optElm.value;
        }
      });
    });

    var filteredData = aceReportViewer.filterViolations(filters);
    updateTableContents(filteredData);
  }

  function applyMetadata(metadata) {

    $("#pub-title").text(metadata["pubTitle"]);
    $("#pub-identifier").text(metadata["pubIdentifier"]);
    $("#software-name").text(metadata["softwareName"]);
    $("#software-version").text(metadata["softwareVersion"]);
    $("#report-date").text(metadata["reportDate"]);

  }

  function populateFilters(filters) {
    $("#filters").empty();

    filters.forEach(function(filter) {
      $("#filters").append("<span class='filter-label'>" + filter.name + "</span>");
      var filterSelect = $("<select name='" + filter.name + "'></select>");
      $("#filters").append(filterSelect);
      filter.values.forEach(function(value) {
        if (value === "all") {
          // preselect 'all'
          filterSelect.append("<option value='all' selected>All</option>");
        }
        else {
          filterSelect.append("<option value='" + value + "'>" + value + "</option>");
        }
      });
    });
    $('select').change(filterSelected);
  }

  $(document).ready(function() {
    aceReportViewer = new AceReport(aceReportData);

    applyMetadata(aceReportViewer.getMetadata());

    // populate filters
    populateFilters(aceReportViewer.getFilters());

    // populate table
    updateTableContents(aceReportViewer.getAllViolations());

  });



  </script>
  <style>
  #filters span, #filters select {
    padding-left: 10px;
    padding-right: 10px;
  }

  .filter-label {
    text-transform: capitalize;
  }
  </style>



  <title>EPUB Accessibility Report by DAISY Ace</title>
</head>
<body>

  <div id="report-metadata" class="jumbotron">
    <h1>EPUB Accessiblity Report</h1>
    <dl>
      <dt>Publication Title</dt>
      <dd id="pub-title"></dd>
      <dt>Publication Identifier</dt>
      <dd id="pub-identifier"></dd>
      <dt>Report generated by</dt>
      <dd><span id="software-name"></span> (<span id="software-version"></span>)</dd>
      <dt>Report created on</dt>
      <dd id="report-date"></dd>
    </dl>
  </div>

  <div class="container-fluid">
    <h1>Violations</h1>

    <div id="filters" class="py-3">
    </div>

    <table id="report-table" class="table table-striped table-bordered">
      <thead class="thead-inverse">
        <tr>
          <th>Impact</th>
          <th>File</th>
          <th>Target</th>
          <th>Rule</th>
          <th>Description</th>
          <th>KB Link</th>
          <th>Engine</th>
        </tr>
      </thead>
      <tbody>
      </tbody>

    </table>
  </div>

</body>

</html>
