<html lang="{{#localize "__language__"}}{{/localize}}">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap4.min.css"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <style>
    /* general */
    body {
      margin: 3em;
    }
    .tab-content {
      margin-top: 2em;
    }

    table th {
      width: auto !important;
    }
    code {
      line-height: 1.5;
    }

    .location {
      font-size:.8em;font-family:monospace;overflow-wrap:break-word
    }

    .snippet {
      font-size:.8em;
    }
    .snippet code {
      display: block;
      font-size:1em;
      font-family:monospace;overflow-wrap:break-word;
      margin-top: 1em;
    }

    .tab-pane{
      margin-top: 1.5em;
      margin-left: 1em;
      margin-bottom: 2em; /* useful for javascriptless (tab-less) linear display mode */
    }

    .pagenav {
      font-style: italic;
      font-size: small;
      margin-top: 1em;
    }

    .sectionnav {
      font-style: italic;
      font-size: small;
      margin-top: 1em;
      margin-bottom: 2em;
    }
    /* metadata */
    #metadata-table tr td:first-child {
      font-family: 'Courier New';
      font-weight: bold;
    }
    .metadata-name {
      font-family: 'Courier New';
      font-weight: bold;
    }
    .metadata-name:after {
      content: ", ";
    }
    .metadata-name:last-child::after {
      content: "";
    }
    #a11y-metadata {
      margin-top: 1em;
    }
    #metadata-table_wrapper {
      padding-left: 0 !important;
    }

    /* TOC outline */
    .toc-h1:before,.toc-h2:before,.toc-h3:before,.toc-h4:before,.toc-h5:before,.toc-h6:before,.toc-missing{
      display:inline-block;
      height:1.5em;
      padding:0 .4em;
      background-color:#449d44;
      border-radius:4px;
      color:#fff;
      font-size:.8em;
      font-family:monospace;
      margin:0 .5em 0 0;
    }

    .toc-h1:before{content:'h1'}
    .toc-h2:before{content:'h2'}
    .toc-h3:before{content:'h3'}
    .toc-h4:before{content:'h4'}
    .toc-h5:before{content:'h5'}
    .toc-h6:before{content:'h6'}
    .toc-missing{font-family:inherit;background-color:#c9302c}

    #toc-outline ol, #html-outline ol {
      list-style: disc;
    }

    /* images */
    #images td {
      text-align: center;
      font-family: serif;
    }
    #images td.image{
      /*text-align:center;*/
      padding:.2em;
    }
    #images td.missing{
      /*text-align:center;*/
      color:#888;
      font-style:italic;
    }
    #images td.alt {border:1px solid #ddd}
    #images td.alt.missing{background-color:#f2dede}
    #images td.alt,td.image.presentation+td.alt.missing{background-color:#dff0d8}
    #images img {
      max-height: 300px;
      max-width: 300px;
    }

    /* violations  */
    #violations-summary-stats-table {
      width: 30%;
    }
    #violations ul:not(.pagination) {
      list-style-type: circle;
    }

    #filters select {
      margin-left: 10px;
      margin-right: 30px;
    }

    .filter-label {
      text-transform: capitalize;
    }

    .engine {
      font-style: italic;
    }
    .engine:before{content: '({{#localize "via"}}{{/localize}} '}
    .engine:after{content: ')'}
    .css:before{content: 'CSS: '}
    .cfi:before{content: 'CFI: '}

    /* make the list and KB link the same padding */
    td.details p{
      padding-left: 40px;
    }

    span.critical, span.serious, span.moderate, span.minor {
      display:inline-block;
      height:1.5em;
      padding: .4em;
      border-radius:4px;
      font-family:monospace;
      font-weight: bold;
    }

    span.critical {
      background-color: #9c2b2e;
      color: #fff;
    }
    span.serious {
      background-color: #ffa500;
      color: #000;
    }
    span.moderate {
      background-color: #7b5000;
      color: #fff;
    }
    span.minor {
      background-color: #ffff7f;
      color: #000;
    }
    #message {
      margin-left: 1em;
    }
    #violations-table_wrapper {
      padding-left: 0 !important;
    }

  </style>

  <title>{{#localize "doctitle"}}{{/localize}}</title>
</head>
<body>

  <header>
    <noscript>
      <div class="alert alert-info">{{#localize "enablejavascript"}}{{/localize}}</div>
    </noscript>

    <h1>{{#localize "doctopheading"}}{{/localize}}</h1>
    <p class="font-italic">{{#generatedBy}}{{/generatedBy}}</p>
    <p><span class="font-weight-bold">{{#localize "title"}}{{/localize}}</span> {{earl:testSubject.metadata.dc:title}}</p>
  </header>

  <nav>
    <ul id="navlist" role="tablist">
      <li class="nav-item"><a class="nav-link active" data-toggle="list" href="#violations" role="tab" aria-controls="violations" id="nav-violations">{{#localize "violations"}}{{/localize}}</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="list" href="#metadata" role="tab" aria-controls="metadata" id="nav-metadata">{{#localize "metadata"}}{{/localize}}</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="list" href="#outlines" role="tab" aria-controls="outlines" id="nav-outlines">{{#localize "outlines"}}{{/localize}}</a></li>
      <li class="nav-item"><a class="nav-link" data-toggle="list" href="#images" role="tab" aria-controls="images" id="nav-images">{{#localize "images"}}{{/localize}}</a></li>
    </ul>
  </nav>


  <!-- Tab panes -->
  <div class="tab-content">

    <!-- VIOLATIONS TAB -->
    <div id="violations" role="tabpanel">
      <h2>{{#localize "violations"}}{{/localize}}</h2>
      <p class="sectionnav">{{#localize "goto"}}{{/localize}} <a href="#summary_of_violations">{{#localize "summaryviolations"}}{{/localize}}</a> | <a href="#all-violations">{{#localize "allviolations"}}{{/localize}}</a> </p>

      <h3 id="summary_of_violations">{{#localize "summaryviolations"}}{{/localize}}</h3>
      <table id="violations-summary-stats-table" class="table table-striped">
        <caption>{{#localize "summaryviolationscaption"}}{{/localize}}</caption>
        <thead class="thead-inverse">
          <tr>
            <th></th>
            <th scope="col">{{#localize "critical"}}{{/localize}}</th>
            <th scope="col">{{#localize "serious"}}{{/localize}}</th>
            <th scope="col">{{#localize "moderate"}}{{/localize}}</th>
            <th scope="col">{{#localize "minor"}}{{/localize}}</th>
            <th scope="col">{{#localize "total"}}{{/localize}}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">WCAG 2.0 A</th>
            {{#violationStats "wcag2a"}}{{/violationStats}}
          </tr>
          <tr>
            <th scope="row">WCAG 2.0 AA</th>
            {{#violationStats "wcag2aa"}}{{/violationStats}}
          </tr>
          <tr>
            <th scope="row">EPUB</th>
            {{#violationStats "EPUB"}}{{/violationStats}}
          </tr>
          <tr>
            <th scope="row">{{#localize "bestpractice"}}{{/localize}}</th>
            {{#violationStats "best-practice"}}{{/violationStats}}
          </tr>
          <tr>
            <th scope="row">{{#localize "other"}}{{/localize}}</th>
            {{#violationStats "other"}}{{/violationStats}}
          </tr>
          <tr>
            <th scope="row">{{#localize "total"}}{{/localize}}</th>
            {{#violationStats "total"}}{{/violationStats}}
          </tr>
        </tbody>
      </table>

      <h3 id="all-violations">{{#localize "allviolations"}}{{/localize}}</h3>

      <div id="filters" class="d-none py-4">
        <span class="filter-label">{{#localize "impact"}}{{/localize}}</span>
        <select name="impact" aria-label="impact">
          <option value="all" selected>{{#localize "all"}}{{/localize}}</option>
          {{#violationFilter "impact"}}{{/violationFilter}}
        </select>
        <span class="filter-label">{{#localize "ruleset"}}{{/localize}}</span>
        <select name="ruleset" aria-label="ruleset">
          <option value="all" selected>{{#localize "all"}}{{/localize}}</option>
          {{#violationFilter "ruleset"}}{{/violationFilter}}
        </select>
        <span class="filter-label">{{#localize "rule"}}{{/localize}}</span>
        <select name="rule" aria-label="rule">
          <option value="all" selected>{{#localize "all"}}{{/localize}}</option>
          {{#violationFilter "rule"}}{{/violationFilter}}
        </select>
        <span class="filter-label">{{#localize "file"}}{{/localize}}</span>
        <select name="file" aria-label="file">
          <option value="all" selected>{{#localize "all"}}{{/localize}}</option>
          {{#violationFilter "file"}}{{/violationFilter}}
        </select>
        <a href="#" onclick="resetFilters()" class="ml-4">{{#localize "resetfilters"}}{{/localize}}</a>
      </div>

      <table id="violations-table" class="table table-bordered">
        <caption>{{#localize "allviolationscaption"}}{{/localize}}</caption>
        <thead class="thead-inverse">
          <tr>
            <th>{{#localize "impact"}}{{/localize}}</th>
            <th>{{#localize "ruleset"}}{{/localize}}</th>
            <th>{{#localize "rule"}}{{/localize}}</th>
            <th>{{#localize "location"}}{{/localize}}</th>
            <th>{{#localize "details"}}{{/localize}}</th>
          </tr>
        </thead>
        <tbody>
          {{#violationRows}}{{/violationRows}}
        </tbody>
      </table>

      <p class="pagenav">{{#localize "goto"}}{{/localize}} <a href="#violations">{{#localize "topsection"}}{{/localize}}</a> | <a href="#navlist">{{#localize "pagenav"}}{{/localize}}</a></p>
    </div>

    <!-- METADATA TAB -->
    <div id="metadata" role="tabpanel">
      <h2>{{#localize "metadata"}}{{/localize}}</h2>

      <p class="sectionnav">{{#localize "goto"}}{{/localize}} <a href="#all-metadata">{{#localize "allmetadata"}}{{/localize}}</a> | <a href="#a11y-metadata">{{#localize "a11ymetadata"}}{{/localize}}</a> </p>

      <h3 id="all-metadata">{{#localize "allmetadata"}}{{/localize}}</h3>
      <table id="metadata-table" class="table table-bordered">
        <caption>{{#localize "pubmetadatacaption"}}{{/localize}}</caption>
        <thead class="thead-inverse">
          <tr>
            <th>{{#localize "name"}}{{/localize}}</th>
            <th>{{#localize "value"}}{{/localize}}</th>
          </tr>
        </thead>
        <tbody>
          {{#each earl:testSubject.metadata}}
          <tr>
            <td>{{@key}}</td>
            <td>{{this}}</td>
          </tr>
          {{/each}}
          {{!-- handlebars was complaining about an #if statement here so it was replaced with a helper --}}
          {{!-- dcterms:conformsTo is a special case metadata item (actually it lives in the links section) --}}
          {{#insertConformsToRow}}{{/insertConformsToRow}}
        </tbody>
      </table>

      <h3 id="a11y-metadata">{{#localize "a11ymetadata"}}{{/localize}}</h3>

      {{#if a11y-metadata.present}}
        <p>{{#localize "a11ymetadatapresent"}}{{/localize}}
        {{#each a11y-metadata.present}}
          <span class="metadata-name">{{this}}</span>
        {{/each}}
        </p>
      {{else}}
        <p>{{#localize "a11ymetadatanotfound"}}{{/localize}}</p>
      {{/if}}

      {{!-- a little messy because handlebars templates have no logical operators --}}
      {{#if a11y-metadata.missing }}
        <p>{{#localize "a11ymetadatamissing"}}{{/localize}}
        {{#each a11y-metadata.missing}}
          <span class="metadata-name">{{this}}</span>
        {{/each}}
        {{#each a11y-metadata.empty}}
          <span class="metadata-name">{{this}}</span>
        {{/each}}
        .
        </p>
      {{else}}
        {{#if a11y-metadata.empty}}
          <p>{{#localize "a11ymetadatamissing"}}{{/localize}}
            {{#each a11y-metadata.missing}}
              <span class="metadata-name">{{this}}</span>
            {{/each}}
            .
          </p>
        {{/if}}
      {{/if}}
      <p class="pagenav">{{#localize "goto"}}{{/localize}} <a href="#metadata">{{#localize "topsection"}}{{/localize}}</a> | <a href="#navlist">{{#localize "pagenav"}}{{/localize}}</a></p>
    </div>

    <!-- OUTLINES TAB -->
    <div id="outlines" role="tabpanel">
      <h2>{{#localize "outlines"}}{{/localize}}</h2>
      <p class="sectionnav">{{#localize "goto"}}{{/localize}} <a href="#toc-outline">{{#localize "tocoutline"}}{{/localize}}</a> | <a href="#headings-outline">{{#localize "headsoutline"}}{{/localize}}</a> | <a href="#html-outline">{{#localize "htmloutline"}}{{/localize}}</a> </p>

      <div class="row">

        <div class="col-sm" id="toc-outline">
          <h3>{{#localize "tocoutline"}}{{/localize}}</h3>
          {{{outlines.toc}}}
        </div>

        <div class="col-sm" id="headings-outline">
          <h3>{{#localize "headsoutline"}}{{/localize}}</h3>
          {{{outlines.headings}}}
        </div>

        <div class="col-sm" id="html-outline">
          <h3>{{#localize "htmloutline"}}{{/localize}}</h3>
          {{{outlines.html}}}
      </div>
    </div>
    <p class="pagenav">{{#localize "goto"}}{{/localize}} <a href="#outlines">{{#localize "topsection"}}{{/localize}}</a> | <a href="#navlist">{{#localize "pagenav"}}{{/localize}}</a></p>
  </div>

  <!-- IMAGES TAB -->
  <div id="images" role="tabpanel">
      <h2>{{#localize "images"}}{{/localize}}</h2>
      {{#if data.images}}
        <table  id="image-table" class="table table-striped table-bordered">
          <caption>{{#localize "imagescaption"}}{{/localize}}</caption>
          <thead class="thead-inverse">
             <tr>
                <th>{{#localize "image"}}{{/localize}}</th>
                <th><code>alt</code>
                </th>
                <th><code>aria-describedby</code>
                </th>
                <th><code>figcaption</code></th>
                <th>{{#localize "location"}}{{/localize}}</th>
                <th>{{#localize "role"}}{{/localize}}</th>
             </tr>
          </thead>
          <tbody>
              {{#each data.images}}
                <tr>
                  <td class="image">
                    <a href="data/{{src}}">
                      <img src = "data/{{src}}"/>
                    </a>
                  </td>

                  {{#if alt}}
                    <td>{{alt}}</td>
                  {{else}}
                    <td class="missing">{{#localize "na"}}{{/localize}}</td>
                  {{/if}}

                  {{#if describedby}}
                    <td>{{describedby}}</td>
                  {{else}}
                    <td class="missing">{{#localize "na"}}{{/localize}}</td>
                  {{/if}}

                  {{#if figcaption}}
                    <td>{{figcaption}}</td>
                  {{else}}
                    <td class="missing">{{#localize "na"}}{{/localize}}</td>
                  {{/if}}

                  <td class="location">{{location}}</td>

                  {{#if role}}
                    <td>{{role}}</td>
                  {{else}}
                    <td class="missing">{{#localize "na"}}{{/localize}}</td>
                  {{/if}}
                </tr>
              {{/each}}
          </tbody>
        </table>
      {{else}}
        <p>{{#localize "noimages"}}{{/localize}}</p>
      {{/if}}
      <p class="pagenav">{{#localize "goto"}}{{/localize}} <a href="#images">{{#localize "topsection"}}{{/localize}}</a> | <a href="#navlist">{{#localize "pagenav"}}{{/localize}}</a></p>
    </div>

  </div> <!-- end div for tabs' contents -->


  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap4.min.js"></script>

  <script type="text/javascript">

    // https://datatables.net/reference/option/language
    // https://datatables.net/examples/basic_init/language.html
    // https://datatables.net/manual/i18n
    const dataTableInit = {
        "language": {
            "decimal":        "",
            "emptyTable":     '{{#localize "dataTable_emptyTable"}}{{/localize}}',
            "info":           '{{#localize "dataTable_info"}}{{/localize}}',
            "infoEmpty":      '{{#localize "dataTable_infoEmpty"}}{{/localize}}',
            "infoFiltered":   '{{#localize "dataTable_infoFiltered"}}{{/localize}}',
            "infoPostFix":    "",
            "thousands":      ",",
            "lengthMenu":     '{{#localize "dataTable_lengthMenu"}}{{/localize}}',
            "loadingRecords": '{{#localize "dataTable_loadingRecords"}}{{/localize}}',
            "processing":     '{{#localize "dataTable_processing"}}{{/localize}}',
            "search":         '{{#localize "dataTable_search"}}{{/localize}}',
            "zeroRecords":    '{{#localize "dataTable_zeroRecords"}}{{/localize}}',
            "paginate": {
                "first":      '{{#localize "dataTable_paginateFirst"}}{{/localize}}',
                "last":       '{{#localize "dataTable_paginateLast"}}{{/localize}}',
                "next":       '{{#localize "dataTable_paginateNext"}}{{/localize}}',
                "previous":   '{{#localize "dataTable_paginatePrevious"}}{{/localize}}'
            },
            "aria": {
                "sortAscending":  '{{#localize "dataTable_ariaSortAscending"}}{{/localize}}',
                "sortDescending": '{{#localize "dataTable_ariaSortDescending"}}{{/localize}}'
            }
        }
    };

  // keep a flat list of the violations in memory for table filtering
  var violations = {{#violationsJson}}{{/violationsJson}}

  // update the contents of the table to reflec the filtering
  function updateTableContents(violationSubset) {
    // anything else is 'other'
    var rulesetTagLabels = {
      'wcag2a': 'WCAG 2.0 A',
      'wcag2aa': 'WCAG 2.0 AA',
      'EPUB': 'EPUB',
      'best-practice': '{{#localize "bestpractice"}}{{/localize}}',
      'other': '{{#localize "other"}}{{/localize}}'
    };

    $('#violations-table').dataTable().fnDestroy();
    $("#message").remove();
    if (violationSubset.length == 0) {
      $('<p id=\'message\'>{{#localize "noMatchingViolations"}}{{/localize}}</p>').insertBefore("#violations .pagenav");
      $("#violations-table").hide();
      return;
    }

    $("#violations-table").show();
    $("#filters").show();

    var tablebody = $("#violations-table > tbody");
    tablebody.empty();

    violationSubset.forEach(function(violation) {

      var tr = $("<tr></tr>");
      var tdImpact = $("<td><span class='" + violation["impact"] + "'>" + violation["impact"] + "</span></td>");
      var tdRuleset = $("<td><span class='ruleset'>" + rulesetTagLabels[violation["applicableRulesetTag"]] + "</span></td>");
      var tdLocation = $("<td><em>\"" + violation["fileTitle"] + "\"</em><br/><br/><code class='location'>" + violation["location"] + "</code></td>");
      if (violation.html) {
        var tdSnippet = $('<br/><br/><div class=\'snippet\'>{{#localize "snippet"}}{{/localize}} <code>'+ violation.html.trim() + "</code></div>");
        tdLocation.append(tdSnippet);
      }
      var tdRule = $("<td>" + violation["rule"] + "<br/><br/><span class='engine'>" + violation["engine"] + "</span></td>");

      var desc = violation["desc"];

      var detailsArr = desc.split("\n");
      var tdDetails = $("<td class='details'></td>");

      var ul = $("<ul></ul>");
      tdDetails.append(ul);
      detailsArr.forEach(function(item) {
        if (item != "") {
          var elm = $("<li></li>");
          elm.text(decodeEntities(item));
          ul.append(elm);
        }
      });
      var link = $("<p><a href='"
        + violation["kburl"]
        + '\' target=\'_blank\'>{{#localize "learnmoreabout"}}{{/localize}} ' + violation["kbtitle"] + "</a></p>");
      tdDetails.append(link);

      tr.append(tdImpact);
      tr.append(tdRuleset);
      tr.append(tdRule);
      tr.append(tdLocation);
      tr.append(tdDetails);
      tablebody.append(tr);
    });

    $('#violations-table').DataTable(dataTableInit);
  }

  function filterSelected() {
    var filters = [];
    $("#filters select").each(function(idx, elm) {
      $(elm).children("option").each(function (idx, optElm) {
        if (optElm.selected) {
          filters[elm.name] = optElm.value;
        }
      });
    });
    var filteredData = filterViolations(filters);
    updateTableContents(filteredData, true);
  }

  // expects:
  // {"rule": "all", "impact": "serious", "file": "p1.xhtml"}
  function filterViolations(filters) {
    var filteredList = [];
    violations.forEach(function(item) {
      if (
        (filters["rule"] == "all" || item["rule"] === filters["rule"])
        &&
        (filters["impact"] == "all" || item["impact"] === filters["impact"])
        &&
        (filters["file"] == "all" || item["file"] === filters["file"])
        &&
        (filters["ruleset"] == "all" || item["applicableRulesetTag"] === filters["ruleset"])
      )
      {
        filteredList.push(item);
      }
    });
    return filteredList;
  }

  function resetFilters() {
    $("#filters select").each(function(idx, elm) {
      $(elm).children("option").each(function (idx, optElm) {
        optElm.selected = optElm.value == "all";
      });
    });
    filterSelected();
  }

  function decodeEntities(text) {
    // The entities tend to appear in violation descriptions, and there are just a few named ones involved
    var namedEntities = {
      "&lt;": "<",
      "&gt;": ">",
      "&quot;": "\"",
      "&nbsp": " "
    };
    // process entities
    var str = text.replace(/&#(\d+);/g, function(match, dec) {
      return String.fromCharCode(dec);
		});

    //process named entities
    Object.keys(namedEntities).forEach(k => {
      str = str.replace(new RegExp(k, 'g'), namedEntities[k]);
    });
    return str;
  }

  // certain classes need to be added to elements if we're using javascript in the browser
  function prepareForJS() {
    $('#filters').removeClass('d-none');
    $('#navlist').addClass('nav-tabs nav');
    $('#violations').addClass('tab-pane active');
    $('#metadata').addClass('tab-pane');
    $('#outlines').addClass('tab-pane');
    $('#images').addClass('tab-pane');
  }
  $(document).ready(function() {
    prepareForJS();
    $('#metadata-table').DataTable(dataTableInit);
    //updateTableContents(violations, false);
    $('#violations-table').DataTable(dataTableInit);
    $('#filters > select').change(filterSelected);
  });

  </script>


</body>
</html>
